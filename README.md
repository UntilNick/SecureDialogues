# SecureDialogues

Приложение добавляет уровень шифрования
сообщений, которые передаются через такие сервисы, как **Gmail**.

Каждое сообщение снабжается электронной подписью. Это позволяет 
выполнить аутентификацию собеседника и проверить целостность сообщения.

Вся корреспонденция, которая пересылается между пользователями,
шифруется 256-битным сеансовым ключом по алгоритму **AES**. Они не сохраняются
на долговременном носителе и генерируются каждый раз, как только пользователи 
создают диалог. Это значительно повышает стойкость системы к методам криптоанализа.

Приложение выполняет авторизацию на сторонних сервисах для передачи сообщений по протоколу 
**OAuth2**. Такой подход позволяет пользователям управлять доступом приложения к их аккаунту, 
а так же исключить риск компрометации паролей. 

Все данные, которые приложение сохраняет на жестком диске, шифруются с помощью 
256-битного ключа по протоколу **AES**. Данный ключ генерируется из пароля, который задает пользователь.

На данный момент доступна передача сообщений через сервис **Gmail**, но ведутся работы по расширению этого списка.

Дополнительная информация находится в [wik проекта](https://github.com/sqglobe/SecureDialogues/wiki/Главная).
Документация проекта - в парке **doc**

## Сборка

Для выполнения сборки необходимы:

* cmake версии **3.8** и выше.
* Qt5
* git
* [cpprestsdk](https://github.com/Microsoft/cpprestsdk) версии **2.10.12** и выше.
* Boost (filesystem, system)
* [asio non-Boost](https://think-async.com/Asio/) версии **1.10.8** и выше.

Ниже перечислены модули, которые так же используются при сборке, но они либо добавлены в репозиторий,
либо будут склонированы во время сборки:

* [CryptoPP](https://www.cryptopp.com/)
* [crossguid](https://github.com/graeme-hill/crossguid)
* [spdlog](https://github.com/gabime/spdlog)

Так же для успешного разбора **CMakeLists.txt**  может потребоваться задать переменную **CMake** - `CMAKE_PREFIX_PATH`.


Для генерации документации понадобятся:

* [asciidoctor-pdf](https://asciidoctor.org/docs/asciidoctor-pdf)
* [plantuml](http://plantuml.com/)

Команда для инициализации зависимостей:

```
git submodule init
git submodule update
```

Чтобы собрать проект без тестов, необходимо выполнить в папке с проектом
```
cmake -DBUILD_TESTING=OFF .
make
```

По умолчанию проект собирается с тестами.

Для запуска тестов достаточно выполнить команды:

```
make
make test
```

Во время сборки, будет склонирована актуальная версия библиотеки **CryptoPP** в папку с проектом и выполнена ее статическая линковка.

Бинарный файл находится в папке **bin** в дирректории сборки, а текущая документация в папке **documents** в дирректории сборки.

## Форматирование кода

Для форматирования кода используется **clang-format**. 
В корне проекта находится файл **.clang-format** с описанием правил форматирования. Для того, чтобы применить их для всего проекта 
достаточно выполнить команду:
```
find . \( -name '*.cpp' -o -name '*.h' \) -exec clang-format -i {} \;
```

Добавлено автоматическое форматирование кода с использованием **git-hook**. Для того, чтобы это заработало, необходимо выполнить команду:
```
git config core.hooksPath .githooks
```

## Docker

Для сборки проекта может использоваться Docker.
Образы находятся в **docker**.

**docker image** создается командой

```
docker build -t <image-name> --file docker/<docker file> .
```

Где:

* **image-name** имя образа
* **docker file** docker-файл, который используется для сборки под конкретную платформу.

Например, для создания образа **ubuntu** **bionic** достаточно выполнить команду:

```
docker build -t secure-dialogues-ubuntu-bionic --file docker/ubuntu-bionic .
```

Среда сборки ожидает, что папка с исходными кодами смонтирована в /app/src, а папка, 
куда выгружаются бинарные файлы и собранная документация в, смонтирована в /app/res.

Исходя из изложенного, проект собирается командой:

```
docker run  --mount type=bind,source=<result folder>,target=/app/res --mount type=bind,source=<sources>,target=/app/src <image-name>
```

Где:

* **result folder** папка, в которую будут скопированы бинарные файлы и документация. Дирректория должна существовать.
* **sources** путь к исходникам
* **image-name** ранее созданный docker-образ

Пример:

```
docker run  --mount type=bind,source=/tmp/github/res,target=/app/res --mount type=bind,source=/tmp/github/SecureDialogues,target=/app/src secure-dialogues-ubuntu-bionic
```

Добавлен make-файл **docker/Makefile** для сборки с помощью **docker** приложения под платформы:

* **ubuntu 18.04** 
* **ubuntu 16.04**
* **centos 7**

## Запуск приложения в Docker

Добавлена возможность запустить приложение в контейнере.
Для этого в **Makefile** в дирректории **docker** включена цель **docker**. Эта цель собирает проект под **Ubuntu 18.04**, используя **ubuntu-bionic.docker**.
Затем создается **image** и запускается контейнер с приложением внутри. 

Возможна такая ситуация, когда расширение [Xsecurity](https://www.x.org/releases/X11R7.7/doc/man/man7/Xsecurity.7.xhtml) блокирует неавторизованные подключения к X-серверу.
Решить проблему поможет команда:

```
xhost +local:
```
